%\section{Reasoning by Binary Optimization}

\section{Optimization of Sparse Tensors}

Let us now study the problem of searching for the maximal coordinate in a tensor, when the tensor is represented in a basis+ CP Format. 


% Appearance of 
The search for maximal coordinates appears in various reasoning tasks:
\begin{itemize}
	\item MAP query: $\hypercore$ is the contraction of evidence with the distribution, leaving the query variables open.
	\item Grafting: $\hypercore$ is the contraction of the gradient of the likelihood with the relational encoding of the hypothesis.
\end{itemize}
Both tasks have been formulated as mode search problems in exponential families.


%\red{Search for the maximal coordinate in a tensor network is a binary optimization problem, given leg dimensions of 2.
%We explain this perspective in this chapter and connect it to the HUBO/QUBO formalism.}


%We here draw on the definition of formulas by binary polynomials.
%Markov Logic Networks are also by definition polynomials (when placing the weighted exponentiation to the head core).
%Thus, many reasoning tasks can be formulated as the maximation of binary polynomials, which are well-studied problems of higher-order binary optimization.

%\red{Here binary refers to the leg dimensions $\catdimof{\atomenumerator}$ being 2, not to binary coordinates!}




\subsection{Higher-Order Unconstrained Binary Optimization (HUBO)}

Here binary refers to the leg dimensions $\catdimof{\atomenumerator}$ being 2, not to binary coordinates as often refered to in this work.

\begin{definition}
	The binary optimization of a tensor $\hypercore\in\bigotimes_{\atomenumeratorin}\rr^2$ is the problem
	\begin{align}\tag{$\mathrm{P}_{\hypercore}$}\label{prob:HUBO}
		\argmax_{\atomindices\in[2]} \hypercore(\atomindices) %\contractionof{\{\hypercore,\onehotmapof{\atomindices}\}}{\varnothing}  \, .
	\end{align}
	We call Problem~\ref{prob:HUBO} a Higher Order Unconstrained Binary Optimization (HUBO) problem of order $\atomorder$ and sparsity $\slicesparsityof{\hypercore}$.
\end{definition}


% Leg dimension needs to be 2
The leg dimension needs to be 2, in order to interpret indices as tuple of binaries.
Legs with larger dimensions can be splitted into binary legs using a categorical constraint tensor.


% 
The sparsity $\slicesparsityof{\hypercore}$ is the minimal number of monomials, for which a weighted sum is equal to $\hypercore$.
Thus we interpret Problem~\ref{prob:HUBO} as searching for the maximum in a polynomial consistent of $\slicesparsityof{\hypercore}$ monomial terms.


\begin{remark}[Sparsity]% To sparse Tensor Calculus?

The number $\slicesparsityof{\hypercore}$ of a tensor $\hypercore$ defining a HUBO is of central importance to have an effective solution.
%Here the number of nonzero coordinates coincides with the number of monomials required to represent the polynomial as a sum.

\red{We investigated the Sparsity as the slice sparsity not the vector sparsity in Chapter~\ref{cha:sparseTC}.}
%We here investigate, whether the same reasoning assumptions used for sparse representation by tensor networks also lead to $\ell_0$-sparse tensors. 

\end{remark}




\subsection{Quadratic Unconstrained Binary Optimization (QUBO)}

We refine the monomial decomposition of tensors (see Definition~\ref{def:polynomialSparsity}) by demanding that monomials consist of at most two variables.

\begin{definition}
	We call a monomial decomposition $\mathcal{M}$ of a tensor $\hypercore\in\bigotimes_{\atomenumeratorin}\rr^2$ a quadratic decomposition, if $\cardof{\variableset}\leq 2$ for all $(\lambda,\variableset,\catindexof{\variableset}) \in \mathcal{M}$.
	We denote the smallest cardinality $\cardof{\mathcal{M}}$ among quadratic decompositions of $\hypercore$ by $\quacprankof{\hypercore}$.

	If a tensor $\hypercore\in\bigotimes_{\atomenumeratorin}\rr^2$ has a quadratic decomposition, we call Problem~\ref{prob:HUBO} a Quadratic Unconstrained Binary Optimization (QUBO) problem of sparsity $\quacprankof{\hypercore}$.
\end{definition}

%\begin{definition}
%	A quadratic decomposition of a tensor $\hypercore\in\bigotimes_{\atomenumeratorin}\rr^2$ consists of index sets $\indexsetof{\variableset}$ to each $\variableset\subset[\atomorder]$ and values $\scalarcoreof{\variableset, \catindexof{\variableset}}\in\rr$ for each $\catindexof{\variableset}\in \indexsetof{\variableset}$ such that
%	\begin{align} % Almost copied from monomial decomposition
%		\hypercore 
%			= \sum_{\variableset\subset[\atomorder], \cardof{\variableset}\leq2} \sum_{\catindexof{\variableset}\in \indexsetof{\variableset}}  
%			\scalarcoreof{\variableset, \catindexof{\variableset}} \cdot \left( \onehotmapof{\catindexof{\variableset}} \otimes \onesof{[\atomorder]/\variableset} \right)   \, . 
%	\end{align} 
%	We denote the smallest cardinality $\# \left( \bigcup_{\variableset\subset[\atomorder]} \indexsetof{\variableset} \right)$ among quadratic decompositions of $\hypercore$ by $\quacprankof{\hypercore}$.
%	When $\hypercore$ admits a quadratic decomposition, we call Problem~\ref{prob:HUBO} a Quadratic Unconstrained Binary Optimization (QUBO) problem of order $\atomorder$ and sparsity $\quacprankof{\hypercore}$.
%\end{definition}

% CP Decompositions
Analogously to monomial decompositions, quadratic decompositions have an equivalence in a CP decomposition of $\hypercore$.
Beyond being binary tensors, the leg cores are further restricted that for each slice $\decindexin$ at most two of them are basis vectors and the rest trivial vectors $\ones$.

% Existence
We notice, that there are tensors, for which no quadratic decomposition exists.
This is already obvious from the fact, that the tensors with a quadratic decomposition build a $\binom{\atomorder}{2}$ dimensional submanifold in the $2^\atomorder$ dimensional tensor space.
This is in contrast with monomial decompositions, where one can always construct a decomposition.



%% OLD THEOREM: FALSE!
%However, for any non-negative tensor $\hypercore$ the Problem~\ref{prob:HUBO} is equivalent to a QUBO problem of possibly larger order as we state next.
%To turn HUBO problems into QUBO we need the slack variable trick, as described in the next lemma.

%\begin{theorem}\label{the:HUBOtoQUBO}
%	Let there be a tensor $\hypercore\in\in\bigotimes_{\atomenumeratorin}\rr^2$, which has a monomial decomposition with dimension $r$ and non-negative scalar core $\scalarcore$.
%	Then, the HUBO defined by $\hypercore$ is equivalent to a QUBO of order at most $\atomorder+r$ and sparsity at most $\atomorder \cdot r $.
%%	The maximal coordinate problem to any tensor $\hypercore\in\bigotimes_{\atomenumeratorin}\rr^2$ is equivalent to a QUBO with at most $\atomorder+\slicesparsityof{\hypercore}$ variables.
%%	\red{Need positive coordinates!}
%\end{theorem}

%To show the theorem we state the following lemma.


We can transform certain HUBO problems in QUBO problems with the usage of auxiliary variables, as we show in the next lemma.

%% Slack variables
\begin{lemma}\label{lem:monomialToQUBO}
	For any $\atomindices\in[2]$ and $\variableset\subset[\atomorder]$ we have 
		\[ \left( \prod_{\atomenumerator\in\variableset} \atomlegindexof{\atomenumerator } \right)  \left(  \prod_{\atomenumerator\notin\variableset} (1- \atomlegindexof{\atomenumerator }) \right)
		=
		\max_{\slackvariable\in[2]} \slackvariable \cdot 2 \cdot \left( \sum_{\atomenumerator\in\variableset}\atomlegindexof{\atomenumerator}  - \cardof{\variableset} - \sum_{\atomenumerator\notin\variableset}\atomlegindexof{\atomenumerator} + \frac{1}{2} \right) \, . % Alternative: no factor 2, but + 1 instead of +1/2 (->pyqubo)
 		\]
\end{lemma}
\begin{proof} %Proof by case distinction
	Only if $\atomlegindexof{\atomenumerator}=1$ for $\atomenumerator\in\variableset$ and $\atomlegindexof{\atomenumerator}=0$ else we have
		\[ \left( \sum_{\atomenumerator\in\variableset}\atomlegindexof{\atomenumerator}  - \cardof{\variableset} - \sum_{\atomenumerator\notin\variableset}\atomlegindexof{\atomenumerator} + \frac{1}{2} \right) \geq 0 \, . \]
	In this case the maximum is taken for $\slackvariable=1$ and we have
		\[ \max_{\slackvariable\in[2]} \slackvariable \cdot 2 \cdot \left( \sum_{\atomenumerator\in\variableset}\atomlegindexof{\atomenumerator}  - \cardof{\variableset} - \sum_{\atomenumerator\notin\variableset}\atomlegindexof{\atomenumerator} + \frac{1}{2} \right) 
		= 1 = \left( \prod_{\atomenumerator\in\variableset} \atomlegindexof{\atomenumerator } \right)  \left(  \prod_{\atomenumerator\notin\variableset} (1- \atomlegindexof{\atomenumerator }) \right) \, . \]
	In all other cases, the maximum is taken for $\slackvariable=0$ and thus vanishes, that is 
		\[ \max_{\slackvariable\in[2]} \slackvariable \cdot 2 \cdot \left( \sum_{\atomenumerator\in\variableset}\atomlegindexof{\atomenumerator}  - \cardof{\variableset} - \sum_{\atomenumerator\notin\variableset}\atomlegindexof{\atomenumerator} + \frac{1}{2} \right) 
		= 0 = \left( \prod_{\atomenumerator\in\variableset} \atomlegindexof{\atomenumerator } \right)  \left(  \prod_{\atomenumerator\notin\variableset} (1- \atomlegindexof{\atomenumerator }) \right) \, . \]
	Thus, the claim holds in all cases.
\end{proof}	


%\begin{proof}[Proof of Theorem~\ref{the:HUBOtoQUBO}]
%	For each summand in the monomial decomposition apply Lemma~\ref{lem:monomialToQUBO}.
%\end{proof}



\subsection{Integer Linear Programming}

Let us now show how optimization problems can be represented as linear programming problems.



\begin{definition}
	A Binary Integer Linear Program (ILP) is a problem of the form
	\begin{align*}
		\max_{x \in\{0,1\}^n} c^T x \quad \text{subject to } \quad A^{upper} x \leq b^{upper} , A^{lower} x \geq b^{lower} 
	\end{align*}
	where $A^{upper}\in\rr^{n^{upper}\times n}$, $b^{upper}\in\rr^{n^{upper}}$, $A^{lower}\in\rr^{n^{lower}\times n}$, $b^{lower}\in\rr^{n^{lower}}$.
\end{definition}



\begin{theorem}
	Given a monomial decomposition $\sliceset=\enumeratedslices$ of a tensor $\hypercore$ we define an Binary ILP as the maximation of 
	\begin{align*}
		\sum_{\decindexin} \slicescalar^{\decindex} \slackvariable^{\decindex} 
	\end{align*}
	with the constraints for any $\decindex$
	\begin{itemize}
		\item 
		\begin{align*}
			\slackvariable^{\decindex}  \leq \catvariableof{\atomenumerator} \quad \text{for} \quad \atomenumerator\in\variableset^j , \catindexof{\atomenumerator} = 1
		\end{align*}
		\item 
		\begin{align*}
			\slackvariable^{\decindex}  \leq (1-\catvariableof{\atomenumerator}) \quad \text{for} \quad \atomenumerator\in\variableset^j , \catindexof{\atomenumerator} = 0
		\end{align*}
		\item 
		\begin{align*}
			\slackvariable^{\decindex} \geq 1 + \sum_{\atomenumerator\in\variableset^{\decindex} : \catindexof{\atomenumerator} = 1} (\catvariableof{\atomenumerator} -1)
		- \sum_{\atomenumerator\in\variableset^{\decindex} : \catindexof{\atomenumerator} = 0} \catvariableof{\atomenumerator} 
		\end{align*}
	\end{itemize}
	The solution $\catindex^{ILP,\sliceset}$ of this ILP and the solution $\catindex^{HUBO,\sliceset}$ of the HUBO coincide on the variables of hypercore, i.e.
		\[ \catindex^{ILP,\sliceset}|_{[d]} =  \catindex^{HUBO,\sliceset} \, . \]
\end{theorem}
\begin{proof}
	We have to show that the constraints are satisfied if and only if $\slackvariable^{\decindex}=\onehotmapofat{\catvariableof{\variableset^{\decindex}}^{\decindex}}{\indexedcatvariableof{\variableset^{\decindex}}}$.
\end{proof}



