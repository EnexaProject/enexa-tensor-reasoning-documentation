\documentclass[aps,onecolumn,nofootinbib,pra]{article}

\usepackage{../../article_compilation/spec_files/arxiv}
\usepackage{amsmath,amsfonts,amssymb,amsthm,bbm,graphicx,enumerate,times}
\usepackage{mathtools}
\usepackage[usenames,dvipsnames]{color}
\usepackage{hyperref}
\hypersetup{
    breaklinks,
    colorlinks,
    linkcolor=gray,
    citecolor=gray,
    urlcolor=gray,
    pdftitle={},
    pdfauthor={Alex Goessmann}
}

\usepackage{tikz}
\usepackage{graphicx}
\usepackage{float}
\usepackage{comment}
\usepackage{csquotes}

\usepackage{braket}

\usepackage{listings}
\usepackage{verbatim}
\usepackage{etoolbox}
\usepackage{braket}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage[T1]{fontenc}
\usepackage{titlesec}
\usepackage{fancyhdr}
\usepackage{bbm}
\usepackage{bm}
\usepackage{algpseudocode}
\usepackage{algorithm}
\usepackage{lipsum}

\newtheorem{remark}{Remark}
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}
\newtheorem{corollary}{Corollary}
\newtheorem{definition}{Definition}
\newtheorem{example}{Example}

\input{../../macros/organization_macros.tex}
\input{../../macros/general_macros.tex}
\input{../../macros/tc_macros.tex}
\input{../../macros/tikz_macros.tex}

\pretolerance=500
\tolerance=100
\emergencystretch=10pt

% Bibliography
\DeclareUnicodeCharacter{FB01}{fi}
\usepackage[round]{natbib}
\usepackage{wasysym}


\newcommand{\red}[1]{\textcolor{red}{#1}}

\begin{document}
    \title{Quantum Circuits for \tnreason{}}

    \maketitle
    \date{\today}

    By its central axioms, quantum mechanics of multiple qubits is formulated by tensors capturing states and discrete time evolutions.
    Motivated by the structural similarity, we investigate how quantum circuits can be utilized for the tensor-network based approach towards efficient and explainable AI in the \tnreason{} framework.

    We follow two main ideas:
    \begin{itemize}
        \item \textbf{Sampling of \ComputationActivationNetworks{}:} Prepare quantum states, which measurement statistics can be utilized to prepare samples from \ComputationActivationNetworks{}.
        \item \textbf{Quantum Circuits as Contraction providers:} Quantum circuits are contractions of multiple tensors and therefore tensor networks, and measurement probabilities are given by contractions.
        Here we investigate how we can exploit these as contraction provider for \tnreason{}.
    \end{itemize}

    \tableofcontents


    \section{Circuit Encoding Schemes}

    We investigate here quantum pendants to the function encoding schemes used in \tnreason{}{}.

    \begin{itemize}
        \item Pendant for Coordinate Encoding: \textbf{\ActivationCircuit{}}, storing the function value in the amplitude of an ancilla qubit.
        \item Pendant for Basis Encoding: \textbf{\ComputationCircuit{}}, with composition by contraction property.
    \end{itemize}

    Both are defined using controlled single qubit gates (see Sections 4.2-3 in [Nielsen, Chuang]), where the incoming qubit variable is $\avariableof{\insymbol}$ and the outgoing $\avariableof{\outsymbol}$
    \begin{align*}
        \yrotationofat{\alpha}{\avariableof{\insymbol},\avariableof{\outsymbol}} \coloneqq
        \begin{bmatrix}
            \cosof{\frac{\alpha}{2}} & -\sinof{\frac{\alpha}{2}} \\
            \sinof{\frac{\alpha}{2}} & \cosof{\frac{\alpha}{2}}
        \end{bmatrix}
    \end{align*}

    Further we use the Pauli-X:
    \begin{align*}
        \paulixat{\avariableof{\insymbol},\avariableof{\outsymbol}} \coloneqq
        \begin{bmatrix}
            0 & 1 \\
            1 & 0
        \end{bmatrix}
    \end{align*}


%    \subsection{\ActivationCircuit{}}
%
%    \begin{definition}[\ActivationCircuit{}]
%        Given a probability distribution $\probtensor:\atomstates\rightarrow\rr$ (i.e. $\contraction{\probtensor}=1$ and $\zeros \prec \probtensor$) its \ActivationCircuit{} is
%        \begin{align*}
%            V^{\probtensor}{\catvariableof{[\atomorder],\insymbol},\catvariableof{[\atomorder],\outsymbol}}
%            = \sum_{\shortcatindicesin} \sqrt{\probat{\indexedshortcatvariables}} \cdot
%            \onehotmapofat{\shortcatindices}{\catvariableof{[\atomorder],\insymbol}}
%            \otimes \onehotmapofat{\shortcatindices}{\catvariableof{[\atomorder],\outsymbol}} \, .
%        \end{align*}
%    \end{definition}

    \subsection{\ActivationCircuit{}}

    \begin{figure}
        \begin{center}
            \input{./tikz_pics/ancilla_augmentation.tex}
        \end{center}
        \caption{
            Ancilla augmentation.
            a) Augmented distribution.
            b) Corresponding encoding of the conditional probability distribution.
        }\label{fig:ancillaAugmentation}
    \end{figure}

    Given a distribution $\probat{\shortcatvariables}$ we add an ancilla variable $\avariable$ and define the augmented distribution (see \figref{fig:ancillaAugmentation})
    \begin{align*}
        \secprobat{\avariable,\shortcatvariables} =
        \frac{1}{\prod_{\catenumeratorin}\catdimof{\catenumerator}}
        \sum_{\shortcatindicesin} \onehotmapofat{\shortcatindices}{\shortcatvariables}
        \otimes \Big(
        \probat{\shortcatindices} \cdot \tbasisat{\avariable} + (1- \probat{\shortcatindices}) \cdot \fbasisat{\avariable}
        \Big) \, .
    \end{align*}
    Then we have
    \begin{align*}
        \secprobat{\shortcatvariables|\avariable=1} = \probat{\shortcatvariables} \, .
    \end{align*}


    %% Angle preparing
    We define the angle preparing function on $p\in[0,1]$ by
    \begin{align*}
        h(p) = 2 \cdot \mathrm{cos}^{-1}\left(\sqrt{1-p}\right) \, .
    \end{align*}
    For any $p\in[0,1]$ we then have
    \begin{align*}
        \contractionof{\onehotmapofat{0}{\avariableof{\insymbol}},\yrotationofat{h(p)}{\avariableof{\insymbol},\avariableof{\outsymbol}}}{\avariableof{\outsymbol}}
        = \begin{bmatrix}
              \sqrt{1-p} \\
              \sqrt{p}
        \end{bmatrix} \, .
    \end{align*}

    \begin{definition}[\ActivationCircuit{}]
        Given a function
        \begin{align*}
            \exfunction : \bigtimes_{\selindexin} [2] \rightarrow [0,1]
        \end{align*}
        its \activationCircuit{} is the unitary tensor
        $\qcaencodingofat{\hypercore}{\avariableof{\insymbol},\avariableof{\outsymbol},\headvariableof{\insymbol,[\seldim]},\headvariableof{\outsymbol,[\seldim]}}$ which satisfies for each $\headindexof{[\seldim]}$
        \begin{align*}
            \qcaencodingofat{\hypercore}{\avariableof{\insymbol},\avariableof{\outsymbol},\headvariableof{\insymbol,[\seldim]},\headvariableof{\outsymbol,[\seldim]}}
            = \sum_{\headindexof{[\seldim]}} \onehotmapofat{\headindexof{[\seldim]}}{\headvariableof{\insymbol,[\seldim]}}
            \otimes \onehotmapofat{\headindexof{[\seldim]}}{\headvariableof{\insymbol,[\seldim]}}
            \otimes \yrotationofat{h(\exfunctionat{\headindexof{[\seldim]}})}{\avariableof{\insymbol},\avariableof{\outsymbol}} \, .
        \end{align*}
    \end{definition}

    \begin{figure}
        \begin{center}
            \input{./tikz_pics/ancilla_augmentation.tex}
        \end{center}
        \caption{
            Ancilla augmentation.
        }
    \end{figure}


%    \begin{definition}[Ancilla \activationCircuit{}]
%        Given a non-negative tensor $\hypercoreat{\headvariables}$ its ancilla \activationCircuit{} is the unitary tensor
%        $\qcaencodingofat{\hypercore}{\avariableof{\insymbol},\avariableof{\outsymbol},\headvariableof{\insymbol,[\seldim]},\headvariableof{\outsymbol,[\seldim]}}$ which satisfies for each $\headindexof{[\seldim]}$
%        \begin{align*}
%            \qcaencodingofat{\hypercore}{\avariableof{\insymbol}=0,\avariableof{\outsymbol},\headvariableof{\insymbol,[\seldim]}=\headindexof{[\seldim]},\headvariableof{\outsymbol,[\seldim]}=\headindexof{[\seldim]}}
%            = \frac{\hypercoreat{\headvariables=\headindexof{[\seldim]}}}{\max_{\secheadindexof{[\seldim]}} \hypercoreat{\headvariables=\secheadindexof{[\seldim]}}} \, .
%        \end{align*}
%    \end{definition}

    % The ancilla \activationCircuit{} is the pendant of the coordinate encoding of $\sqrt{\probtensor}$ (see Chapter Coordinate Calculus).

    Tensors $\hypercoreat{\headvariables}$ with non-negative coordinates can be encoded after dividing them by their maximum, that is the \activationCircuit{} of the function
    \begin{align*}
        \exfunctionat{\headindexof{[\seldim]}} = \frac{\hypercoreat{\headvariables=\headindexof{[\seldim]}}}{\max_{\secheadindexof{[\seldim]}} \hypercoreat{\headvariables=\secheadindexof{[\seldim]}}}
    \end{align*}
    When the maximum of the tensor is not known, it can be replaced by an upper bound (reducing the acceptance rate of the rejection sampling).

    \subsubsection{Encoding of directed tensors}

    Following the schemes in \cite{low_quantum_2014}, we can prepare any non-negative tensors by a sequence of controlled rotations.
    To this end, one iterates over the states of the incoming variables, and performs a controlled rotation on the outgoing variable, where the angle is given by the value of the tensor at the incoming state.
    This generalizes the basis encoding scheme, which demands boolean tensors


    \begin{figure}
        \begin{center}
            \input{./tikz_pics/directed_to_circuit.tex}
        \end{center}
        \caption{
            Representation of directed and positive tensor by a controlled rotation.
            a) Conditional probability tensor $\condprobat{\catvariableof{\catenumerator}}{\catvariableof{\parentsof{\catenumerator}}}$ being a tensor in a Bayesian Network.
            b) Circuit Encoding as a controlled rotation, which is the \ActivationCircuit{} of the tensor $\condprobat{\catvariableof{\catenumerator}=1}{\catvariableof{\parentsof{\catenumerator}}}$.
        }
    \end{figure}

    \subsection{\ComputationCircuits{}}

    We here suggest a quantum pendant to basis encodings (see Chapter Basis Calculus), which has the decomposition by contraction property.

    \begin{definition}[\ComputationCircuit{}]
        Given a boolean function $\exfunction:\atomstates\rightarrow[2]$ the \computationCircuit{} is the unitary tensor
        \begin{align*}
            &\qcbencodingofat{\exfunction}{\headvariableof{\insymbol,\exfunction},\headvariableof{\outsymbol,\exfunction},\catvariableof{\insymbol,[\atomorder]},\catvariableof{\outsymbol,[\atomorder]}} \\
            &\quad=
            \sum_{\shortcatindicesin\wcols\exfunctionat{\shortcatindices}=1}
            \paulixat{\headvariableof{\insymbol,\exfunction},\headvariableof{\outsymbol,\exfunction}} \otimes
            \onehotmapofat{\shortcatindices}{\catvariableof{\insymbol,[\atomorder]}} \otimes \onehotmapofat{\shortcatindices}{\catvariableof{\outsymbol,[\atomorder]}} \\
            & \quad \quad +
            \sum_{\shortcatindicesin\wcols\exfunctionat{\shortcatindices}=0}
            \identityat{\headvariableof{\insymbol,\exfunction},\headvariableof{\outsymbol,\exfunction}} \otimes
            \onehotmapofat{\shortcatindices}{\catvariableof{\insymbol,[\atomorder]}} \otimes \onehotmapofat{\shortcatindices}{\catvariableof{\outsymbol,[\atomorder]}} \, .
        \end{align*}
    \end{definition}

%    \begin{definition}[\computationCircuit{}]
%        Given a boolean function $\exfunction:\atomstates\rightarrow[2]$ the \computationCircuit{} is the unitary tensor
%        \begin{align*}
%            &U^{\exfunction}[\indexedcatvariableof{\insymbol,[\atomorder]},\indexedcatvariableof{\outsymbol,[\atomorder]},\headvariableof{\insymbol,\exfunction},\headvariableof{\outsymbol,\exfunction}] \\
%            &\quad=
%            \begin{cases}
%                \zerosat{\headvariableof{\insymbol},\headvariableof{\outsymbol}}
%                & \ifspace \catindexof{\insymbol,[\atomorder]}\neq\catindexof{\outsymbol,[\atomorder]} \\
%                \onesat{\headvariableof{\insymbol},\headvariableof{\outsymbol}} - \identityat{\headvariableof{\insymbol},\headvariableof{\outsymbol}}
%                & \ifspace \exfunctionat{\catindexof{\insymbol,[\atomorder]}} = 1 \\
%                \identityat{\headvariableof{\insymbol},\headvariableof{\outsymbol}}
%                & \ifspace \exfunctionat{\catindexof{\insymbol,[\atomorder]}} = 0 \\
%            \end{cases}
%        \end{align*}
%    \end{definition}

    Notice, that $U^{\lnot} = \mathrm{CNOT}$, which is obvious from $\onesat{\headvariableof{\insymbol},\headvariableof{\outsymbol}} - \identityat{\headvariableof{\insymbol},\headvariableof{\outsymbol}}$ being the Pauli-X gate (not to be confused with $X$ denoting distributed variables here).
    The \computationCircuit{} is therefore a generalized controlled $\mathrm{NOT}$ gate, where the control is by a boolean function.

    Functions with multiple output variables, i.e. $\exfunction:\atomstates\rightarrow\bigtimes_{\selindexin}[2]$, can be encoded image coordinate wise as a concatenation of the respective circuits.

    \subsubsection{Composition by Contraction - Exploiting \DecompositionSparsity{}}

    The decomposition by contraction property of basis encodings is now a composition of circuits property, as stated in the next lemma.

    \begin{lemma}
        We have for functions $\exfunction:\atomstates\rightarrow\bigtimes_{\selindexin}[2]$, $\secexfunction:\bigtimes_{\selindexin}[2]\rightarrow\bigtimes_{s\in[r]}[2]$ (see \figref{fig:qcbencodingDecomposition})
        \begin{align*}
            \qcbencodingofat{\secexfunction\circ\exfunction}{\headvariableof{\insymbol,\secexfunction\circ\exfunction},\headvariableof{\outsymbol,\secexfunction\circ\exfunction},\catvariableof{\insymbol,[\atomorder]},\catvariableof{\outsymbol,[\atomorder]}}
            = \breakablecontractionof{
                &\onehotmapofat{0}{\headvariableof{\insymbol,\exfunction}},\\
                &\qcbencodingofat{\exfunction}{\headvariableof{\insymbol,\exfunction},\headvariableof{\outsymbol,\exfunction},\catvariableof{\insymbol,[\atomorder]},\catvariableof{\outsymbol,[\atomorder]}},\\
                &\qcbencodingofat{\secexfunction}{\headvariableof{\insymbol,\secexfunction\circ\exfunction},\headvariableof{\outsymbol,\secexfunction\circ\exfunction},\headvariableof{\outsymbol,\exfunction},\headvariableof{\outsymbol,\exfunction}}
            }{
                \headvariableof{\insymbol,\secexfunction\circ\exfunction},\headvariableof{\outsymbol,\secexfunction\circ\exfunction},\catvariableof{\insymbol,[\atomorder]},\catvariableof{\outsymbol,[\atomorder]}
            } \, .
        \end{align*}
    \end{lemma}


    \begin{figure}
        \begin{center}
            \input{./tikz_pics/decomposition_sparsity.tex}
        \end{center}
        \caption{
            Exploitaition of \DecompositionSparsity{} in \computationCircuit{}s.
        }\label{fig:qcbencodingDecomposition}
    \end{figure}


%    \begin{lemma}
%        We have for functions $\exfunction:\atomstates\rightarrow\bigtimes_{\selindexin}[2]$, $\secexfunction:\bigtimes_{\selindexin}[2]\rightarrow\bigtimes_{s\in[r]}[2]$
%        \begin{align*}
%            \qcbencodingofat{\secexfunction\circ\exfunction}{\catvariableof{\insymbol,[\atomorder]},\catvariableof{\outsymbol,[\atomorder]},\headvariableof{\insymbol,\secexfunction\circ\exfunction},\headvariableof{\outsymbol,\secexfunction\circ\exfunction}}
%            = \breakablecontractionof{
%                &\onehotmapofat{0}{\headvariableof{\insymbol,\exfunction}},\\
%                &\qcbencodingofat{\exfunction}{\catvariableof{\insymbol,[\atomorder]},\catvariableof{\outsymbol,[\atomorder]},\headvariableof{\insymbol,\exfunction},\headvariableof{\outsymbol,\exfunction}},\\
%                &\qcbencodingofat{\secexfunction}{\headvariableof{\outsymbol,\exfunction},\headvariableof{\outsymbol,\mathrm{aux}},\headvariableof{\insymbol,\secexfunction\circ\exfunction},\headvariableof{\outsymbol,\secexfunction\circ\exfunction}}
%            }{
%                \catvariableof{\insymbol,[\atomorder]},\catvariableof{\outsymbol,[\atomorder]},\headvariableof{\insymbol,\secexfunction\circ\exfunction},\headvariableof{\outsymbol,\secexfunction\circ\exfunction}
%            } \, .
%        \end{align*}
%    \end{lemma}

    Note, that the variables $\headvariableof{\outsymbol,\mathrm{aux}}$ are auxiliar and not left open in the contraction.
    This amounts to not measuring them in a computational basis measurement.

    \subsubsection{Construction for mod2-basis+ CP decompositions - Exploiting \PolynomialSparsity{}}

    Concatenating two \computationCircuit{}s is the \computationCircuit{} of their mod2 sum.

    A basis+ elementary function can be encoded by a single controlled NOT operation with auxiliary X qubits.

    This motivates the mod2-basis+ CP decomposition of tensors.

    \begin{definition}
        Given a boolean tensor $\hypercore$, a mod2-basis+ CP decomposition is a collection $\sliceset$ of tuples $(\variableset,\catindexof{\variableset})$ with such that for any $\shortcatindicesin$
        \begin{align*}
            \hypercoreat{\indexedshortcatvariables}
            = \bigoplus_{(\variableset,\catindexof{\variableset})\in\sliceset} \contractionof{\onehotmapofat{\catindexof{\variableset}}{\catvariableof{\variableset}}}{\indexedshortcatvariables} \, .
        \end{align*}
    \end{definition}

    Using that basis CP decompositions are a special case of basis+ CP decompositions, we get the following rank bound.

    \begin{lemma}
        The mod2-basis+ CP rank is bounded by the basis CP rank.
    \end{lemma}
    \begin{proof}
        Use $\variableset=[\atomorder]$, and $\catindexof{\variableset}$ to each supported state.
        Then the mod2-sum is a usual sum and the basis CP decomposition is also a mod2-basis+ CP decomposition.
    \end{proof}

    This shows in particular, that any propositional formula can be represented by a mod2-basis+ CP decomposition.

    \begin{lemma}
        The \computationCircuit{} to a boolean tensor $\hypercore$ with a mod2-basis+ CP decomposition $\sliceset$ obeys
        \begin{align*}
            &\qcbencodingofat{\hypercore}{
                \headvariableof{\hypercore,\insymbol},\headvariableof{\hypercore,\outsymbol},\catvariableof{[\atomorder],\insymbol},\catvariableof{[\atomorder],\insymbol}
            } \\
            & \quad =
            \breakablecontractionof{
                \{\identityat{\headvariableof{\hypercore,\insymbol},\headvariableof{0}},\identityat{\headvariableof{\hypercore,\outsymbol},\headvariableof{\cardof{\sliceset}-1}}\} \cup
                \{\qcbencodingofat{\onehotmapof{\catindexof{\variableset}}}{
                    \headvariableof{\decindex}, \headvariableof{\decindex+1},
                    \catvariableof{\variableset,\insymbol},\catvariableof{\variableset,\outsymbol}} \wcols (\variableset,\catindexof{\variableset})\in\sliceset\}
            }{\headvariableof{\hypercore,\insymbol},\headvariableof{\hypercore,\outsymbol},\catvariableof{[\atomorder],\insymbol},\catvariableof{[\atomorder],\outsymbol}}
        \end{align*}
        where $\decindex\in[\cardof{\sliceset}]$ enumerates the tuples in $\sliceset$.
    \end{lemma}

    The \computationCircuit{} to each boolean monomial has a representation by a multiple controlled $\paulixsymbol$ gate and further pairs of $\paulixsymbol$ gates preparing the control state, see \figref{fig:qcbencodingPolynomial}.

    \begin{figure}
        \begin{center}
            \input{./tikz_pics/polynomial_sparsity.tex}
        \end{center}
        \caption{
            Exploitaition of \PolynomialSparsity{} in \computationCircuit{}s.
        }\label{fig:qcbencodingPolynomial}
    \end{figure}

    \subsubsection{Preparation by fine and coarse structure}

    Having a mod2-basis+ CP decomposition of rank $r$ to a connective, we need $r$ controlled NOT gates to prepare the basis encoding.
    Given a syntactical decomposition of a boolean statistics, we prepare the basis encoding as a circuit with:
    \begin{itemize}
        \item \textbf{Fine Structure:} Represent each logical connective based on its mod2-basis+ CP decomposition, as a concatenation of \computationCircuit{}s with the same variables.
        \item \textbf{Coarse Structure:} Arrange the logical connective representing circuits according to the syntactical hypergraph, where parent head variables appear as distributed variables at their children.
    \end{itemize}


    \section{Sampling from \ComputationActivationNetworks{} as Quantum Circuits}

    \tnreason{} provides tensor network representations of knowledge bases and exponential families following a Computation Activation architecture.
    Here are some ideas to utilize quantum circuits for sampling \ComputationActivationNetworks{}.

    \begin{figure}
        \begin{center}
            \input{./tikz_pics/ca_circuit.tex}
        \end{center}
        \caption{
            Quantum Circuit to reproduce a \ComputationActivationNetwork{} (with elementary activation) by rejection sampling.
            We measure the distributed qubits $\shortcatvariables$ and the ancilla qubits $\avariableof{[\seldim]}$ and reject all samples, where an ancilla qubit is measured as $0$.
        }
    \end{figure}


    We can produce Q-samples for ancilla augmented \ComputationActivationNetworks{}  using basis circuit encodings of the computation cores and ancilla encodings of the activation cores.

    \subsection{Generic Q-samples}

    In general, we define Q-samples to be quantum states, which measured in the computational basis reproduce a given probability distribution.

    \begin{definition}[Q-sample]
        Given a probability distribution $\probtensor:\atomstates\rightarrow\rr$ (i.e. $\contraction{\probtensor}=1$ and $\zeros \prec \probtensor$) its q-sample is
        \begin{align*}
            \qstateofat{\probtensor}{\shortcatvariables}
            = \sum_{\shortcatindicesin} \sqrt{\probat{\indexedshortcatvariables}} \cdot \onehotmapofat{\shortcatindices}{\shortcatvariables} \, .
        \end{align*}
    \end{definition}

    In \cite{low_quantum_2014} the \activationCircuit{} is called q-sample.
    It prepares a scheme to realize property 1 (purity) + 2 (q-sampling) of a qpdf, but fails to realize property 3 (q-stochasticity).
    The q-sample can be prepared for Bayesian Networks, where each child qubit is prepared densely by C-NOTs conditioning on parent qubits.

    Q-samples can be prepared by \activationCircuit{}s acting on uniform quantum states (Hadamard gates acting on ground state).

%    \begin{lemma}
%        The \activationCircuit{} of $\probwith$ acting on the uniform state of $\shortcatvariables$ prepares a q-sample.
%    \end{lemma}
%    \begin{proof}
%        Follows directly from construction:
%        The uniform state is the action of Hadamard gates on the ground state $\onehotmapofat{0}{\shortcatvariables}$, which prepares the state $\normalizationof{\ones}{\shortcatvariables}$.
%        The diagonal \activationCircuit{} transforms
%    \end{proof}

    Doing rejection sampling on the ancilla qubit corresponds with sampling from the normalized contraction with the activation tensor.

    \begin{lemma}
        Given a distribution $\probat{\shortcatvariables}$, we construct a circuit preparing its q-sample and add the ancilla encoding of a tensor $\hypercoreat{\shortcatvariables}$.
        The rejection sampling scheme, measuring the ancilla qubit and the $\shortcatvariables$ qubits, rejecting the ancilla qubit measured as $0$, prepares samples from the distribution
        \begin{align*}
            \normalizationof{\probat{\shortcatvariables},\hypercoreat{\shortcatvariables}}{\shortcatvariables} \, .
        \end{align*}
    \end{lemma}

    %% NEEDED ALREADY HERE?
    For more flexible sampling schemes of \ComputationActivationNetworks{} we need to introduce ancilla qubits.

    \begin{definition}[Ancilla Augmented Distribution]
        Let $\probwith$ be a probability distribution over variables $\shortcatvariables$.
        Another joint distribution of $\shortcatvariables$ and ancilla variables $\avariables$ is called an ancilla augmented distribution, if
        \begin{align*}
            \condprobof{\shortcatvariables}{\avariables=\onesat{[\seldim]}} = \probwith \, .
        \end{align*}
    \end{definition}

    Sampling from the distribution can be done by rejection sampling on the ancilla augmented distribution, measuring all variables and rejecting all samples where an ancilla variable is $0$.

%    \begin{definition}[Augmented \activationCircuit{}]
%        \label{def:augmentedQsample}
%        Let there be a probability distribution $\probtensor:\atomstates\rightarrow\rr$ and qubit variables $\shortcatvariables$ and ancilla qubit variables $\avariables$.
%        We call a quantum state $\qstateofat{\probtensor}{\shortcatvariables,\avariables}$ an augmented \activationCircuit{}, if
%        \begin{align*}
%            |\qstateofat{\probtensor}{\shortcatvariables,\avariables=\onesat{[\seldim]}}|^2 = \probat{\shortcatvariables}
%        \end{align*}
%%        \red{Problematic: This contraction does not match the computational basis measurement!}
%    \end{definition}

    %% Usage through rejection sampling
    Given an augmented Q-sample of a distribution, we can prepare samples from the distribution by rejection sampling, measuring all variables $\shortcatvariables$ and $\avariables$ and rejecting all samples where an ancilla qubit is measured as $0$.

    %% Usage as forward inferer
    When sampling from probability distributions, we can use these samples to estimate probabilistic queries.
    Building on such particle-based inference schemes, we can perform various inference schemes for \ComputationActivationNetworks{}, such as backward inference and message passing schemes.

    \subsection{Preparation of Ancilla Qubits}

    \red{Using the ancilla encoding of activation cores!}

    We introduce a ancilla qubit, which stores in its coefficient to the first state the probability of the configuration (this is the ancilla encoding!).
    When we have a probability tensor, this can be prepared, since all values are in $[0,1]$.
    For the rejection sampling, only the quotients of the values are important, we can therefore scale the value by a scalar such that the mode is $1$.
    The value qubit is initialized by the zeroth one hot encoding ($\ket{0}$) and rotated by a controlled rotation gate, which is controlled by the variable qubits.

    To prepare a distribution with sufficient statistics, we prepare the statistic qubits by a \computationCircuit{} and do controlled rotations on the value qubit controlled by the statistic qubits.

    Maximum entropy distribution under moment constraints are a special case of distributions with sufficient statistics.
    In many cases (precisely by mean parameters on the interior of cube faces), they have a factored representation by the features.
    It is unclear, how to exploit this factored representation in the preparation of the controlled value rotations.

    \textbf{Open Question:} How to exploit the factored representation of maximum entropy distributions in the preparation of the value qubit?
    - By a collection of ancilla qubits on each statistic, and doing amplitude amplification on the state of all qubits 1.

    \subsection{Polynomial Sparsity}

    \red{This is exactly the decomposition of boolean polynomials into monomials (which can include 1-x terms)!
    Decompositions is called into terms (products of x or (1-x) factors), and minterms if all variables appear.}

    Each monomial can be prepared by a multiple-controlled NOT gate, where the control qubits are the affected variables and the target qubit is the value qubit.
    When we sum monomials wrt modulus 2 calculus, then the preparation is a sequence of such circuits.
    In such way, we can prepare the \computationCircuit{} to any propositional formula.
    This encoding strategy exploits a modified (by mod2 calculus) polynomial sparsity.

    \subsection{Decomposition Sparsity}

    When having a syntactical decomposition of a propositional formula, we can iteratively apply the \computationCircuit{} decomposition theorem and prepare each connective by a circuit.
    We can decompose any propositional formula into logical connectives and prepare to each a modulus 2 circuit implementation.
    This works, when the target qubit of one connective is used as a value qubit of another.

    \subsection{Quantum Rejection Sampling}

    Note, that the variable qubits are uniformly distributed when only the computation circuit is applied.
    When sampling the probability distribution, we need the value qubit to be in state $1$ in order for the sample to be valid.
    Any other states will have to be rejected.

    Classically, this can be simulated in the same way: Just draw the variables from uniform, calculate the value qubit by a logical circuit inference and accept with probability by the computed value.

    For this procedure to be more effective (and in particular not having an efficient classical pendant), we need amplitude amplification on the value qubit.
    This can provide a square root speedup in the complexity compared with classical rejection sampling.

    \textbf{Open Question:} Is there a way to avoid amplitude amplification and use a more direct circuit implementation of the activation network?
    - Cannot be the case, when the encoding is determined by the activation tensor alone: Needs to use the computated statistic as well.


    \section{Sampling from proposal distributions}

    We can prepare basis circuit encodings to selection augmented formulas, in this way introducing formula selecting networks.

    \textbf{Idea for an inductive reasoning scheme:} Prepare a q-sample from the empirical distribution and the current distribution.
    Then prepare the basis circuit encodings, where the selection variables are shared and the distributed variables assigned to the prepared samples.
    Now, the ancilla qubits can be designed to $\onehotmapof{1}$ and $\onehotmapof{0}$ accordingly.
    The rejection sampling scheme on both ancillas being $1$ and the measurement of $\selvariable$ prepares then the distribution
    \begin{align*}
        \normalizationof{
            \contractionof{\empdistributionwith, \sencmlnstatwith}{\selvariable}, \contractionof{\currentdistributionwith}{\selvariable}
        }{\selvariable}
    \end{align*}
    That is, the probability of selecting $\selindex$ is proportional to
    \begin{align*}
        \datameanat{\indexedselvariable} \cdot (1-\currentmeanat{\indexedselvariable})
    \end{align*}
    and thus prefers formulas, which have a large empirical mean, but a small current mean.

    \textbf{Open Question:} Since the distribution is "similar" to $\expof{\datameanat{\indexedselvariable}-\currentmeanat{\indexedselvariable})}$ (terms appear in Taylor of first order), can we tune the distribution with an inverse temperature parameter $\beta$?


    \section{Implementation}

    The introduced quantum circuit preparation schemes have been implemented in the python package \qcreason{}, which consists in three layers:
    \begin{center}
        \input{./tikz_pics/qcreason_architecture.tex}
    \end{center}

    \appendix


    \section{Comparing tensor networks and quantum circuits}

    First of all, we need to extend to complex tensors, which are maps
    \begin{align*}
        \hypercore : \atomstates \rightarrow \mathbb{C} \,
    \end{align*}
    with image in $\mathbb{C}$ instead of $\mathbb{R}$ as in the report.

    A coarse comparison of the nomenclature used for quantum circuits and tensor networks:

    \begin{center}
        \begin{tabular}{l|l}
            \textbf{Quantum Circuit} & \textbf{Tensor Network}   \\
            \hline
            Qubit                    & Boolean Variable          \\
            Quantum Gate             & Unitary Tensor            \\
            Quantum Circuit          & Tensor Network on a graph
        \end{tabular}
    \end{center}

    Some constraints appear for a tensor network to be a quantum circuit
    \begin{itemize}
        \item \textbf{Unitarity of each gate:} That is the variables of each tensor are bipartite into sets $\variablesetof{\insymbol}$ and $\variablesetof{\outsymbol}$ of same cardinality and the basis encoding with respect to this bipartition, that is
        \begin{align*}
            T_{\insymbol \rightarrow \outsymbol}[\catvariableof{\insymbol},\catvariableof{\outsymbol}] : \bigotimes_{\atomenumerator\in\variablesetof{\insymbol}} \mathbb{C}^2 \rightarrow \bigotimes_{\atomenumerator\in\variablesetof{\outsymbol}} \mathbb{C}^2  \, ,
        \end{align*}
        is a unitary map, that is
        \begin{align*}
            \left(T_{\insymbol \rightarrow \outsymbol}\right)^H \circ \left(T_{\insymbol \rightarrow \outsymbol}\right)
            = \contractionof{
                T_{\insymbol \rightarrow \outsymbol}[\catvariableof{\insymbol},\seccatvariable],
                \overline{T}_{\insymbol \rightarrow \outsymbol}[\seccatvariable,\catvariableof{\outsymbol}]
            }{\catvariableof{\outsymbol},\catvariableof{\insymbol}}
            = \identityat{\catvariableof{\outsymbol},\catvariableof{\insymbol}}.
        \end{align*}
        \item \textbf{Incoming-Outgoing structure:} Variable appear at most once as incoming and at most once as outgoing variables.
        Those not appearing as outgoing (respectively as incoming) are the input and the output variables of the whole circuit.
        \item \textbf{Acyclicity:} Incoming and outgoing variables of each tensor core provide a direction of each edge tensor. With respect to this directionality the graph underlying the tensor network has to be acyclic.
    \end{itemize}

    The unitary tensors can be aligned layerwise, if and only if the last two assumption hold, i.e. the directed graph is acyclic and each variable appears at most once as an incoming and at most once as an outgoing variable.


    %\subsection{Notation}

    %We use the contraction notation of \tnreason{} to denote quantum circuits.


    \section{POVM measurements as contractions}

    The main difficulty of using quantum circuits as contraction providers is that we can only extract information through measurements.
    Therefore measurement is the only way to execute contractions of the circuit, which come with restrictions when interested in contraction with open variables.

    The most general measurement formalism is through a POVM, a set $\{E_\seccatindex \, : \, \seccatindex\in[r]\}$ of positive operators with % Nielsen book notation
    \begin{align*}
        \sum_{\seccatindex\in[r]} E_\seccatindex = I
    \end{align*}

    Measuring a pure state $\ket{\psi}$ We then get outcome $m$ with probability
    \begin{align*}
        \braket{\psi|E_\seccatindex|\psi}
    \end{align*}

    We define a measurement variable $\headvariable$ taking indices $\seccatindex\in[r]$ and a measurement tensor
    \begin{align*}
        E[\headvariable,\catvariableof{\insymbol},\catvariableof{\outsymbol}]
    \end{align*}
    with slices
    \begin{align*}
        E[\headvariable=\seccatindex,\catvariableof{\insymbol},\catvariableof{\outsymbol}] = E_\seccatindex \, .
    \end{align*}

    Repeating the measurement asymptotically on a state $\ket{\psi}$ prepared by a quantum circuit $\tnetof{\graph}$ acting on the trivial start state $\ones$, we denote the measurement outcome by $\seccatindex^\datindex$.
    In the limit $\datanum\rightarrow\infty$ we get almost surely
%    we thus get the contraction
    \begin{align*}
        \frac{1}{\datanum} \sum_{\datindexin} \onehotmapofat{\seccatindex^\datindex}{\headvariable} \rightarrow
        \contractionof{\tnetof{\graph}[\catvariableof{\insymbol}],E[\headvariable,\catvariableof{\insymbol},\catvariableof{\outsymbol}],\tnetof{\secgraph}[\catvariableof{\outsymbol}]}{\headvariable} \, .
    \end{align*}

    % Case of computational basis measurements
    POVMs to computational basis measurements of subsets of qubits are constructed as products with delta tensors on the non-measured qubits.


\end{document}